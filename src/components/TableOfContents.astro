---
export interface TOCItem {
  id: string;
  text: string;
  level: number;
}

interface Props {
  headings: TOCItem[];
}

const { headings } = Astro.props;
---

<aside class="sticky top-8 bg-skill-wanderer-toc-bg rounded-lg p-6 shadow-lg border border-light">
  <div class="mb-4">
    <h3 class="text-lg font-semibold text-skill-wanderer-article-headings mb-3">Table of Contents</h3>
    <!-- Reading Progress Bar -->
    <div class="w-full bg-gray-200 rounded-full h-1 mb-4">
      <div id="reading-progress" class="bg-skill-wanderer-primary-orange h-1 rounded-full transition-all duration-300" style="width: 0%"></div>
    </div>
  </div>
  
  <nav class="space-y-2">
    {headings.map((heading) => (
      <a 
        href={`#${heading.id}`}
        class={`block py-1 px-3 text-sm transition-colors hover:text-skill-wanderer-primary-orange toc-link ${
          heading.level === 2 ? 'font-medium' : 
          heading.level === 3 ? 'ml-4 text-skill-wanderer-article-text' : 
          'ml-8 text-skill-wanderer-article-text text-xs'
        }`}
        data-target={heading.id}
      >
        {heading.text}
      </a>
    ))}
  </nav>
</aside>

<script>
  // Reading progress
  function updateReadingProgress() {
    const article = document.querySelector('article');
    if (!article) return;
    
    const scrollTop = window.scrollY;
    const docHeight = article.offsetHeight;
    const winHeight = window.innerHeight;
    const scrollPercent = scrollTop / (docHeight - winHeight);
    const scrollPercentRounded = Math.round(scrollPercent * 100);
    
    const progressBar = document.getElementById('reading-progress');
    if (progressBar) {
      progressBar.style.width = Math.min(100, Math.max(0, scrollPercentRounded)) + '%';
    }
  }

  // Active TOC highlighting
  function updateActiveTOC() {
    const headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
    const tocLinks = document.querySelectorAll('.toc-link');
    
    let activeHeading = null;
    
    headings.forEach((heading) => {
      const rect = heading.getBoundingClientRect();
      if (rect.top <= 100) {
        activeHeading = heading;
      }
    });
    
    tocLinks.forEach((link) => {
      link.classList.remove('border-l-4', 'border-skill-wanderer-primary-orange', 'bg-white', 'text-skill-wanderer-primary-orange');
      link.classList.add('text-skill-wanderer-article-text');
    });
    
    if (activeHeading) {
      const activeLink = document.querySelector(`.toc-link[data-target="${activeHeading.id}"]`);
      if (activeLink) {
        activeLink.classList.add('border-l-4', 'border-skill-wanderer-primary-orange', 'bg-white', 'text-skill-wanderer-primary-orange');
        activeLink.classList.remove('text-skill-wanderer-article-text');
      }
    }
  }

  // Scroll event listeners
  window.addEventListener('scroll', () => {
    updateReadingProgress();
    updateActiveTOC();
  });
  
  // Initialize on load
  document.addEventListener('DOMContentLoaded', () => {
    updateReadingProgress();
    updateActiveTOC();
  });
</script>
