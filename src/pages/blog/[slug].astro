---
import BlogLayout from '../../layouts/BlogLayout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import { calculateWordCount, calculateReadingTime } from '../../utils/seo.ts';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map((post: CollectionEntry<'posts'>) => ({
    params: { slug: post.slug },
    props: { entry: post },
  }));
}

const { entry } = Astro.props;
const { Content, headings } = await entry.render();

// Calculate word count from the raw content if not provided
const rawContent = entry.body || '';
const calculatedWordCount = (entry.data as any).wordCount || calculateWordCount(rawContent);
const calculatedReadTime = entry.data.readTime || calculateReadingTime(calculatedWordCount);

// Create enhanced post data with calculated values
const enhancedPostData = {
  ...entry.data,
  category: entry.data.category as any, // Type assertion for category
  wordCount: calculatedWordCount,
  readTime: calculatedReadTime
};

// Fetch all posts
const allPosts = await getCollection('posts');

// Filter posts by same category and exclude current post
const relatedPostsData = allPosts.filter(post => 
  post.data.category === entry.data.category && post.slug !== entry.slug
);

// Map filtered posts to the RelatedPost structure
const relatedPosts = relatedPostsData.map(post => ({
  title: post.data.title,
  excerpt: post.data.description, // Using description as excerpt
  slug: post.slug,
  category: post.data.category,
  readTime: post.data.readTime,
  image: post.data.image,
}));
---

<BlogLayout
  post={enhancedPostData}
  headings={headings}
  relatedPosts={relatedPosts}
  currentSlug={entry.slug}
>
  <Content />
</BlogLayout>
